<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>EC021 - Prática Final</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>

<body>
	<div class="mx-auto" style="width: 700px;">
		<div>
			</br>
		</div>
		<center>
			<h3>Listar por Lote Selecionado</h3>
		</center>
		<div>
			</br>
		</div>
		
		<form class="col-lg-12 form-inline">
			
			<!-- SELECT BOX COM OS LOTES -->
			<div class="form-group mx-sm-3 mb-2">
				<select id="lote" class="form-control">
					<option value="">Selecione...</option>
				</select>
			</div>
			
			<!-- CHECK PARA SELECIONAR VECIDOS -->
			<div class="col-lg-12 form-group mx-sm-3 mb-2 form-check">
				<input class="form-check-input" type="checkbox" id="vencidos" value="">
				<label class="form-check-label">
					Incluir Vencidos
				</label>
			</div>
			
			<button class="btn btn-primary mb-2" id="botao">Mostrar/Ocultar dados</button>
		</form>
	
		
		
	
		<div class="col-lg-12">
			<table class="table table-striped" id="tabela" border="1px">
				<thead class="thead-dark">
					<th>ID</th>
					<th>Lote</th>
					<th>Conteúdo</th>
					<th>Validade</th>
				</thead>
				<tbody>
					
				</tbody>
			</table>
		</div>
	
		<div>
			</br>
		</div>
	
		<center>
			<h3>Cadastrar</h3>
		</center>
		<div>
			</br>
		</div>
	
		<form class="col-lg-12">
			<div class="form-group row">
				<label class="col-lg-3 col-form-label">Lote: </label>
				<div class="form-group">
					<select id="lote_input" class="form-control col-lg-12">
						<option value="">Selecione...</option>
					</select>
				</div>
			</div>
			<div class="form-group row">
				<label class="col-lg-3">Conteúdo: </label>
				<input type="number" class="col-lg-9 form-control" id="conteudo_input" placeholder="Entre com o conteúdo">
			</div>
			<div class="form-group row">
				<label class="col-lg-3">Validade:</label>
				<input type="date" class="col-lg-9  form-control" id="validade_input"  placeholder="Validade no formato 01/01/2001">
			</div>
			<center>
				<button type="button" id="botao_cadastrar" class="btn btn-primary">Cadastrar</button>
			</center>
		</form>		
	</div>
	
	

	<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
</body>

</html>

<script>

	
	var mid = 'http://localhost:5000/toddy/';
	// adiciona todos os lotes no select
	$(document).ready(function () {
		$.ajax({
			url: mid + 'buscarLotes',
			type: 'GET',
			success: function (result) {
				$.each(result, function (indice, toddy) {
					$("#lote").append(`<option value="` + toddy.lote + `">Lote: ` + toddy.lote + `</option>`);
					$("#lote_input").append(`<option value="` + toddy.lote + `">Lote: ` + toddy.lote + `</option>`);
				});
			},
			error: function () {
				alert('Houve um erro.');
			}
		})
	});

	// adiciona os valores retornados na tabela
	$("#lote").change(
		function () {
			var lote = this.value; 
			let value_checkBox = false;

			// verifica se esta checado e atribui o valor de true se estiver checado
			if ($('#vencidos').is(":checked")) {
				value_checkBox = true;
			}

			$("#lote").attr("disabled", true); //Desabilito o combobox
			
			$.ajax({
				url: mid + 'buscarPorLote?lote=' + lote + '&vencidos=' + value_checkBox,
				type: 'GET',
				success: function (result) {

					$("#tabela > tbody").empty();

					$.each(result, function (indice, toddy) {
						$("#tabela > tbody").append(
							`<tr>`+
							`<td>`+toddy.id+`</td>`+
							`<td>`+toddy.lote+`</td>`+
							`<td>`+toddy.conteudo+`</td>`+
							`<td>`+toddy.validade+`</td>`+
							`</tr>`
						);
					});

					if(result.length == 0) alert('Sem dados para essa opção')
				},
				error: function () {
					alert('Houve um erro.');
				},
				complete: function () {
					$("#lote").attr("disabled", false); //Terminando habilito o combobox
				}
			})
		}
	);

	$("#botao_cadastrar").click(
		function () {
			let loteValue = $('#lote_input').val();
			let conteudoValue = $('#conteudo_input').val();
			let auxDate = ($('#validade_input').val()).split("-");
			let validadeValue = `${auxDate[2]}/${auxDate[1]-1}/${auxDate[0]}`;

			console.log(loteValue);
			console.log(conteudoValue);
			console.log(validadeValue);

			let body = {
				lote: loteValue,
   				conteudo: conteudoValue,
    			validade: validadeValue
			}

			$.ajax({
				url: mid + 'inserir',
				type: 'POST',
				data: body,
				success: function (result) {
					alert('Que tiro foi esse?!');
					$('#lote_input').val('');;
					$('#conteudo_input').val('');;
					$('#validade_input').val('');;
				},
				error: function () {
					alert('Houve um erro.');
				},
				complete: function () {
					
				}
			})
		}
	);

	$("#botao").click(
		function () {
			//Toggle => exibe ou oculta o tbody
			$("#tabela > tbody").toggle();
		}
	);
</script>